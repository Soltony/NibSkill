
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ORGANIZATIONAL STRUCTURE
model TrainingProvider {
  id            String          @id @default(cuid())
  name          String          @unique
  address       String
  accountNumber String          @unique
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  users         User[]
  roles         Role[]
  districts     District[]
  departments   Department[]
  branches      Branch[]
  products      Product[]
  courses       Course[]
  learningPaths LearningPath[]
  liveSessions  LiveSession[]
  registrationFields RegistrationField[]
  certificateTemplate CertificateTemplate?
}

model District {
  id                String    @id @default(cuid())
  name              String
  branches          Branch[]
  users             User[]
  trainingProviderId String
  trainingProvider  TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  @@unique([name, trainingProviderId])
}

model Branch {
  id                String    @id @default(cuid())
  name              String
  districtId        String
  district          District  @relation(fields: [districtId], references: [id], onDelete: Cascade)
  users             User[]
  trainingProviderId String
  trainingProvider  TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  
  @@unique([name, districtId, trainingProviderId])
}

model Department {
  id                String    @id @default(cuid())
  name              String
  users             User[]
  trainingProviderId String
  trainingProvider  TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  @@unique([name, trainingProviderId])
}

// USER MANAGEMENT & AUTH
model User {
  id                 String   @id @default(cuid())
  name               String
  email              String?  @unique
  phoneNumber        String?  @unique
  password           String
  avatarUrl          String?
  activeSessionId    String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relations
  departmentId       String?
  department         Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  districtId         String?
  district           District?     @relation(fields: [districtId], references: [id], onDelete: SetNull)
  branchId           String?
  branch             Branch?       @relation(fields: [branchId], references: [id], onDelete: SetNull)
  trainingProviderId String?
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  
  roles                 UserRole[]
  loginHistory          LoginHistory[]
  userBadges            UserBadge[]
  completedCourses      UserCompletedCourse[]
  completedModules      UserCompletedModule[]
  purchasedCourses      UserPurchasedCourse[]
  attendedLiveSessions  UserAttendedLiveSession[]
  allowedLiveSessions   LiveSessionAllowedUser[]
  quizSubmissions       QuizSubmission[]
  resetRequests         ResetRequest[]
  notifications         Notification[]
}

model UserRole {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId String

  @@unique([userId, roleId])
}

model Role {
  id                 String  @id @default(cuid())
  name               String
  permissions        Json
  users              UserRole[]
  trainingProviderId String?
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  @@unique([name, trainingProviderId])
}

model LoginHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  loginTime DateTime @default(now())
  ipAddress String?
  userAgent String?
  superAppToken String?
}


// COURSE CONTENT
model Product {
  id                 String   @id @default(cuid())
  name               String
  description        String?
  imageUrl           String
  imageHint          String?
  courses            Course[]
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model Course {
  id                  String    @id @default(cuid())
  title               String
  description         String
  imageUrl            String?
  imageHint           String?
  imageDescription    String?
  isPublic            Boolean   @default(true)
  hasCertificate      Boolean   @default(false)
  isPaid              Boolean   @default(false)
  price               Float?
  currency            Currency?
  status              CourseStatus @default(PENDING)
  rejectionReason     String?
  
  // Relations
  productId           String?
  product             Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  modules             Module[]
  quiz                Quiz?
  trainingProviderId  String
  trainingProvider    TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  // User-related relations
  completedBy         UserCompletedCourse[]
  learningPathCourses LearningPathCourse[]
  purchasedBy         UserPurchasedCourse[]
  pendingTransactions PendingTransaction[]
  resetRequests       ResetRequest[]
}

model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        ModuleType
  duration    Int
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  userCompletions UserCompletedModule[]
}

model LearningPath {
  id                 String      @id @default(cuid())
  title              String
  description        String
  hasCertificate     Boolean     @default(false)
  courses            LearningPathCourse[]
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model LearningPathCourse {
  id              String       @id @default(cuid())
  learningPathId  String
  learningPath    LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  courseId        String
  course          Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  order           Int

  @@unique([learningPathId, courseId])
}

// ASSESSMENT
model Quiz {
  id           String      @id @default(cuid())
  passingScore Int
  timeLimit    Int? // in minutes
  quizType     QuizType    @default(CLOSED_LOOP)
  maxAttempts  Int         @default(0) // 0 for unlimited
  requiresManualGrading Boolean @default(false)
  
  courseId     String      @unique
  course       Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions    Question[]
  submissions  QuizSubmission[]
}

model Question {
  id              String       @id @default(cuid())
  text            String
  type            QuestionType
  weight          Float        @default(1)
  correctAnswerId String // For MCQs/T-F, this is an Option ID. For others, it's the answer text.
  createdAt       DateTime     @default(now())
  quizId          String
  quiz            Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options         Option[]
  answers         Answer[]
}

model Option {
  id         String   @id @default(cuid())
  text       String
  createdAt  DateTime @default(now())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizSubmission {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId    String
  quiz      Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  score     Int?
  status    SubmissionStatus
  submittedAt DateTime  @default(now())
  gradedAt  DateTime?
  answers   Answer[]
}

model Answer {
  id               String   @id @default(cuid())
  submissionId     String
  submission       QuizSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  questionId       String
  question         Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOptionId String?  
  answerText       String?  
}

model ResetRequest {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([userId, courseId])
}


// LIVE SESSIONS
model LiveSession {
  id              String                   @id @default(cuid())
  title           String
  description     String
  speaker         String
  keyTakeaways    String
  dateTime        DateTime
  platform        LiveSessionPlatform
  joinUrl         String
  recordingUrl    String?
  isRestricted    Boolean                  @default(false)
  status          LiveSessionStatus        @default(UPCOMING)
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  
  attendedBy      UserAttendedLiveSession[]
  allowedAttendees LiveSessionAllowedUser[]
}

model UserAttendedLiveSession {
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId   String
  session     LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  attendedAt  DateTime    @default(now())

  @@id([userId, sessionId])
}

model LiveSessionAllowedUser {
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId   String
  session     LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@id([userId, sessionId])
}

// USER PROGRESS & GAMIFICATION
model Badge {
  id          String      @id @default(cuid())
  title       String      @unique
  description String
  icon        String
  userBadges  UserBadge[]
}

model UserBadge {
  userId  String
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId String
  badge   Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  date    DateTime @default(now())

  @@id([userId, badgeId])
}

model UserCompletedCourse {
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId       String
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completionDate DateTime @default(now())
  score          Int

  @@id([userId, courseId])
}

model UserCompletedModule {
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    moduleId String
    module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
    completedAt DateTime @default(now())

    @@id([userId, moduleId])
}


// PAYMENTS
model UserPurchasedCourse {
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    courseId String
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    purchasedAt DateTime @default(now())
    amount Float
    transactionId String?

    @@id([userId, courseId])
}

model PendingTransaction {
  transactionId String @id
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId String
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  amount Float
  createdAt DateTime @default(now())
}


// MISC
model CertificateTemplate {
  id             String      @id @default(cuid())
  title          String
  organization   String
  body           String
  logoUrl        String?
  signatureUrl   String?
  stampUrl       String?
  signatoryName  String
  signatoryTitle String
  primaryColor   String?
  borderStyle    String?
  templateStyle  String?
  trainingProviderId String   @unique
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model RegistrationField {
  id          String  @id
  label       String
  type        FieldType
  enabled     Boolean
  required    Boolean
  options     String[]
  isLoginIdentifier Boolean @default(false)
  createdAt   DateTime @default(now())
  trainingProviderId String?
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: SetNull)
}

model Notification {
  id          String   @id @default(cuid())
  title       String
  description String
  createdAt   DateTime @default(now())
  isRead      Boolean  @default(false)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum ModuleType {
  VIDEO
  PDF
  AUDIO
  SLIDES
}

enum LiveSessionPlatform {
    Zoom
    Google_Meet
}

enum LiveSessionStatus {
  UPCOMING
  LIVE
  ENDED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_THE_BLANK
  SHORT_ANSWER
}

enum QuizType {
  OPEN_LOOP
  CLOSED_LOOP
}

enum CourseStatus {
  PENDING
  PUBLISHED
  REJECTED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
}

enum Currency {
  USD
  ETB
}
