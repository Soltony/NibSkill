
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- Enums ---

enum ModuleType {
  VIDEO
  PDF
  AUDIO
  SLIDES
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_THE_BLANK
  SHORT_ANSWER
}

enum QuizType {
  OPEN_LOOP // Practice quiz, no grade
  CLOSED_LOOP // Graded quiz
}

enum Currency {
  USD
  ETB
}

enum CourseStatus {
  PENDING
  PUBLISHED
  REJECTED
}

enum LiveSessionPlatform {
  Zoom
  Google_Meet
}

enum LiveSessionStatus {
  UPCOMING
  LIVE
  ENDED
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
}

// --- Models ---

model TrainingProvider {
  id            String       @id @default(cuid())
  name          String       @unique
  address       String
  accountNumber String       @unique
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  users         User[]
  roles         Role[]
  products      Product[]
  courses       Course[]
  learningPaths LearningPath[]
  liveSessions  LiveSession[]
  certificateTemplate CertificateTemplate?
  registrationFields RegistrationField[]
}

model User {
  id                   String                  @id @default(cuid())
  name                 String
  email                String?                 @unique
  password             String
  avatarUrl            String?
  phoneNumber          String?                 @unique
  activeSessionId      String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  roleId               String
  departmentId         String?
  districtId           String?
  branchId             String?
  trainingProviderId   String?
  
  role                 Role                    @relation(fields: [roleId], references: [id])
  department           Department?             @relation(fields: [departmentId], references: [id])
  district             District?               @relation(fields: [districtId], references: [id])
  branch               Branch?                 @relation(fields: [branchId], references: [id])
  trainingProvider     TrainingProvider?       @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  
  completedCourses     UserCompletedCourse[]
  completedModules     UserCompletedModule[]
  attendedLiveSessions UserAttendedLiveSession[]
  badges               UserBadge[]
  notifications        Notification[]
  loginHistory         LoginHistory[]
  quizSubmissions      QuizSubmission[]
  allowedLiveSessions  LiveSessionAllowedUser[]

  @@index([trainingProviderId])
}

model Role {
  id                 String  @id @default(cuid())
  name               String
  permissions        Json
  trainingProviderId String?
  
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  users              User[]

  @@unique([name, trainingProviderId])
}

model Product {
  id                 String   @id @default(cuid())
  name               String
  description        String
  imageUrl           String
  imageHint          String?
  trainingProviderId String
  
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  courses            Course[]

  @@index([trainingProviderId])
}

model Course {
  id                 String    @id @default(cuid())
  title              String
  description        String
  imageUrl           String?
  imageHint          String?
  imageDescription   String?
  isPaid             Boolean   @default(false)
  price              Float?
  currency           Currency?
  hasCertificate     Boolean   @default(false)
  status             CourseStatus @default(PENDING)
  rejectionReason    String?
  isPublic           Boolean   @default(true)
  trainingProviderId String

  productId          String
  product            Product   @relation(fields: [productId], references: [id])
  
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  modules            Module[]
  quiz               Quiz?
  completedBy        UserCompletedCourse[]
  learningPathCourses LearningPathCourse[]

  @@index([trainingProviderId])
}

model Module {
  id          String   @id @default(cuid())
  title       String
  description String
  type        ModuleType
  duration    Int
  content     String
  courseId    String
  createdAt   DateTime @default(now())
  
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completedBy UserCompletedModule[]

  @@index([courseId])
}

model Quiz {
  id                    String   @id @default(cuid())
  passingScore          Int
  timeLimit             Int // in minutes, 0 for no limit
  maxAttempts           Int      @default(0) // 0 for unlimited
  quizType              QuizType
  requiresManualGrading Boolean  @default(false)
  
  courseId   String   @unique
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions  Question[]
  submissions QuizSubmission[]
}

model Question {
  id              String   @id @default(cuid())
  text            String
  type            QuestionType
  weight          Float    @default(1)
  quizId          String
  createdAt       DateTime @default(now())
  
  quiz            Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options         Option[]
  correctAnswerId String   // For MULTIPLE_CHOICE or TRUE_FALSE, this is an Option ID. For others, it's the answer string.
  answers         Answer[]

  @@index([quizId])
}

model Option {
  id         String   @id @default(cuid())
  text       String
  questionId String
  createdAt  DateTime @default(now())
  
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers    Answer[]
  
  @@index([questionId])
}

model LearningPath {
    id String @id @default(cuid())
    title String
    description String
    hasCertificate Boolean @default(false)
    trainingProviderId String

    trainingProvider TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
    courses LearningPathCourse[]
}

model LearningPathCourse {
    learningPathId String
    courseId String
    order Int

    learningPath LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

    @@id([learningPathId, courseId])
}

model LiveSession {
    id String @id @default(cuid())
    title String
    speaker String
    description String
    keyTakeaways String
    dateTime DateTime
    platform LiveSessionPlatform
    joinUrl String
    recordingUrl String?
    isRestricted Boolean @default(false)
    trainingProviderId String
    status LiveSessionStatus @default(UPCOMING)

    trainingProvider TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
    attendedBy UserAttendedLiveSession[]
    allowedAttendees LiveSessionAllowedUser[]
}

model District {
  id String @id @default(cuid())
  name String
  trainingProviderId String

  trainingProvider TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  branches Branch[]
  users User[]
}

model Branch {
  id String @id @default(cuid())
  name String
  districtId String
  trainingProviderId String

  trainingProvider TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  district District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  users User[]
}

model Department {
  id String @id @default(cuid())
  name String
  trainingProviderId String

  trainingProvider TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  users User[]
}

model Badge {
    id String @id @default(cuid())
    title String @unique
    description String
    icon String

    users UserBadge[]
}

model CertificateTemplate {
    id String @id @default(cuid())
    trainingProviderId String @unique
    title String
    organization String
    body String
    logoUrl String?
    signatoryName String
    signatoryTitle String
    signatureUrl String?
    stampUrl String?
    primaryColor String?
    borderStyle String?
    templateStyle String?

    trainingProvider TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model RegistrationField {
    id String @id
    label String
    type FieldType
    enabled Boolean @default(false)
    required Boolean @default(false)
    options String[]
    trainingProviderId String?

    trainingProvider TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model Notification {
    id String @id @default(cuid())
    userId String
    title String
    description String
    createdAt DateTime @default(now())
    isRead Boolean @default(false)

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model LoginHistory {
    id String @id @default(cuid())
    userId String
    loginTime DateTime @default(now())
    ipAddress String?
    userAgent String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

// --- Junction Tables for Many-to-Many Relationships ---

model UserCompletedCourse {
    userId String
    courseId String
    completionDate DateTime @default(now())
    score Int

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

    @@id([userId, courseId])
}

model UserCompletedModule {
    userId String
    moduleId String
    completedAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

    @@id([userId, moduleId])
}

model UserAttendedLiveSession {
    userId String
    sessionId String
    attendedAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    session LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

    @@id([userId, sessionId])
}

model UserBadge {
    userId String
    badgeId String
    awardedAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

    @@id([userId, badgeId])
}

model QuizSubmission {
    id String @id @default(cuid())
    userId String
    quizId String
    score Int?
    submittedAt DateTime @default(now())
    gradedAt DateTime?
    status String // PENDING_REVIEW, COMPLETED

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
    answers Answer[]

    @@index([quizId])
}

model Answer {
    id String @id @default(cuid())
    submissionId String
    questionId String
    selectedOptionId String? // For MULTIPLE_CHOICE, TRUE_FALSE
    answerText String? // For FILL_IN_THE_BLANK, SHORT_ANSWER

    submission QuizSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
    question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
    selectedOption Option? @relation(fields: [selectedOptionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    
    @@index([submissionId])
}

model LiveSessionAllowedUser {
    sessionId String
    userId String

    session LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@id([sessionId, userId])
}
