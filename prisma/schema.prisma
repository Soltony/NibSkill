// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model TrainingProvider {
  id              String         @id @default(cuid())
  name            String         @unique
  address         String
  accountNumber   String         @unique
  isActive        Boolean        @default(true)
  users           User[]
  products        Product[]
  courses         Course[]
  learningPaths   LearningPath[]
  liveSessions    LiveSession[]
  roles           Role[]
  districts       District[]
  departments     Department[]
  certificateTemplate CertificateTemplate?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  branches        Branch[]
}

model User {
  id                  String                 @id @default(cuid())
  name                String
  email               String?                @unique
  phoneNumber         String?                @unique
  password            String
  avatarUrl           String?
  trainingProviderId  String?
  trainingProvider    TrainingProvider?      @relation(fields: [trainingProviderId], references: [id])
  departmentId        String?
  department          Department?            @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  districtId          String?
  district            District?              @relation(fields: [districtId], references: [id], onDelete: SetNull)
  branchId            String?
  branch              Branch?                @relation(fields: [branchId], references: [id], onDelete: SetNull)
  roles               UserRole[]
  activeSessionId     String?
  completedModules    UserCompletedModule[]
  completedCourses    UserCompletedCourse[]
  userBadges          UserBadge[]
  attendedSessions    UserAttendedLiveSession[]
  allowedSessions     LiveSessionAllowedUser[]
  quizSubmissions     QuizSubmission[]
  resetRequests       ResetRequest[]
  loginHistory        LoginHistory[]
  notifications       Notification[]
  purchasedCourses    UserPurchasedCourse[]
  pendingTransactions PendingTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id                 String       @id @default(cuid())
  name               String
  permissions        Json
  trainingProviderId String?
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  users              UserRole[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([name, trainingProviderId])
}

model UserRole {
  id      String @id @default(cuid())
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String
  role    Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId  String

  @@unique([userId, roleId])
}

model Product {
  id                 String   @id @default(cuid())
  name               String
  description        String
  imageUrl           String
  imageHint          String?
  courses            Course[]
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CourseStatus {
  PENDING
  PUBLISHED
  REJECTED
}

model Course {
  id                 String              @id @default(cuid())
  title              String
  description        String
  imageUrl           String?
  imageHint          String?
  imageDescription   String?
  productId          String
  product            Product             @relation(fields: [productId], references: [id])
  modules            Module[]
  quiz               Quiz?
  isPaid             Boolean             @default(false)
  price              Float?
  currency           Currency?
  hasCertificate     Boolean             @default(false)
  status             CourseStatus        @default(PENDING)
  rejectionReason    String?
  isPublic           Boolean             @default(true)
  trainingProviderId String
  trainingProvider   TrainingProvider    @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  completedBy        UserCompletedCourse[]
  learningPathCourses LearningPathCourse[]
  resetRequests      ResetRequest[]
  purchasedBy        UserPurchasedCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ModuleType {
  VIDEO
  PDF
  AUDIO
  SLIDES
}

model Module {
  id               String                @id @default(cuid())
  title            String
  type             ModuleType
  duration         Int
  description      String
  content          String
  courseId         String
  course           Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completedBy      UserCompletedModule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuizType {
  OPEN_LOOP
  CLOSED_LOOP
}

model Quiz {
  id                 String           @id @default(cuid())
  courseId           String           @unique
  course             Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions          Question[]
  passingScore       Int
  timeLimit          Int
  quizType           QuizType         @default(CLOSED_LOOP)
  maxAttempts        Int              @default(0)
  requiresManualGrading Boolean       @default(false)
  submissions        QuizSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_THE_BLANK
  SHORT_ANSWER
}

model Question {
  id              String           @id @default(cuid())
  text            String
  type            QuestionType
  quizId          String
  quiz            Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options         Option[]
  correctAnswerId String
  weight          Float            @default(1.0)
  answers         Answer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Option {
  id         String   @id @default(cuid())
  text       String
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers    Answer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubmissionStatus {
  PENDING_REVIEW
  COMPLETED
}

model QuizSubmission {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers     Answer[]
  score       Int?
  status      SubmissionStatus @default(PENDING_REVIEW)
  submittedAt DateTime @default(now())
  gradedAt    DateTime?
}

model Answer {
  id                String          @id @default(cuid())
  submissionId      String
  submission        QuizSubmission  @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  questionId        String
  question          Question        @relation(fields: [questionId], references: [id]) // No cascade, let question deletion fail if answered
  selectedOptionId  String?
  selectedOption    Option?         @relation(fields: [selectedOptionId], references: [id])
  answerText        String?

  @@unique([submissionId, questionId])
}

model LearningPath {
  id                 String             @id @default(cuid())
  title              String
  description        String
  trainingProviderId String
  trainingProvider   TrainingProvider   @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  courses            LearningPathCourse[]
  hasCertificate     Boolean            @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LearningPathCourse {
  learningPathId String
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  courseId       String
  course         Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  order          Int

  @@id([learningPathId, courseId])
}

model Badge {
    id          String       @id @default(cuid())
    title       String       @unique
    description String
    icon        String
    users       UserBadge[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model UserBadge {
    userId  String
    user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    badgeId String
    badge   Badge  @relation(fields: [badgeId], references: [id], onDelete: Cascade)
    assignedAt DateTime @default(now())

    @@id([userId, badgeId])
}

model UserCompletedModule {
    userId   String
    user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    moduleId String
    module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
    completedAt DateTime @default(now())

    @@id([userId, moduleId])
}

model UserCompletedCourse {
    userId   String
    user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    courseId String
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    completionDate DateTime @default(now())
    score    Int

    @@id([userId, courseId])
}

model UserPurchasedCourse {
    userId      String
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    courseId    String
    course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
    purchasedAt DateTime @default(now())
    amount      Float
    transactionId String? @unique

    @@id([userId, courseId])
}

model PendingTransaction {
    id            String   @id @default(cuid())
    transactionId String   @unique
    userId        String
    user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    courseId      String
    amount        Float
    createdAt     DateTime @default(now())
}


enum LiveSessionPlatform {
  Zoom
  Google_Meet
}

enum LiveSessionStatus {
  UPCOMING
  LIVE
  ENDED
}

model LiveSession {
  id                 String                   @id @default(cuid())
  title              String
  description        String
  speaker            String
  keyTakeaways       String
  dateTime           DateTime
  platform           LiveSessionPlatform
  joinUrl            String
  recordingUrl       String?
  attendedBy         UserAttendedLiveSession[]
  isRestricted       Boolean                  @default(false)
  allowedAttendees   LiveSessionAllowedUser[]
  status             LiveSessionStatus
  trainingProviderId String
  trainingProvider   TrainingProvider         @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LiveSessionAllowedUser {
    sessionId String
    session   LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    userId    String
    user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@id([sessionId, userId])
}

model UserAttendedLiveSession {
    userId    String
    user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    sessionId String
    session   LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    attendedAt DateTime   @default(now())

    @@id([userId, sessionId])
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
}

model RegistrationField {
  id                  String   @id
  label               String
  type                FieldType
  enabled             Boolean
  required            Boolean
  options             String[]
  isLoginIdentifier   Boolean? @default(false)
  trainingProviderId  String?  // Null for global fields
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model LoginHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  loginTime   DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  superAppToken String?
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
}

enum Currency {
  USD
  ETB
}

model CertificateTemplate {
  id                  String    @id @default(cuid())
  trainingProviderId  String    @unique
  trainingProvider    TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  title               String
  organization        String
  body                String
  logoUrl             String?
  signatureUrl        String?
  stampUrl            String?
  signatoryName       String
  signatoryTitle      String
  primaryColor        String?
  borderStyle         String?
  templateStyle       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model District {
  id                String   @id @default(cuid())
  name              String
  trainingProviderId String
  trainingProvider  TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  branches          Branch[]
  users             User[]
}

model Branch {
  id                 String           @id @default(cuid())
  name               String
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  districtId         String
  district           District         @relation(fields: [districtId], references: [id])
  users              User[]
}

model Department {
  id                String   @id @default(cuid())
  name              String
  trainingProviderId String
  trainingProvider  TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  users             User[]
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model ResetRequest {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([userId, courseId])
}
