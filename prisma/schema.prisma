// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id                 String     @id @default(cuid())
  name               String
  email              String?
  phoneNumber        String?
  password           String
  avatarUrl          String?
  activeSessionId    String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  
  departmentId       String?
  districtId         String?
  branchId           String?
  trainingProviderId String?

  roles              UserRole[]
  department         Department? @relation(fields: [departmentId], references: [id])
  district           District?   @relation(fields: [districtId], references: [id])
  branch             Branch?     @relation(fields: [branchId], references: [id])
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: SetNull)

  completedCourses   UserCompletedCourse[]
  completedModules   UserCompletedModule[]
  attendedSessions   UserAttendedLiveSession[]
  quizSubmissions    QuizSubmission[]
  resetRequests      ResetRequest[]
  loginHistory       LoginHistory[]
  notifications      Notification[]
  badges             UserBadge[]
  allowedLiveSessions LiveSessionAllowedUser[]
}

model Role {
  id          String @id @default(cuid())
  name        String 
  permissions Json
  trainingProviderId String?
  
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  users       UserRole[]

  @@unique([name, trainingProviderId])
}

model UserRole {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId String

  @@unique([userId, roleId])
}

model TrainingProvider {
  id             String    @id @default(cuid())
  name           String    @unique
  address        String
  accountNumber  String    @unique
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  users          User[]
  roles          Role[]
  courses        Course[]
  products       Product[]
  learningPaths  LearningPath[]
  liveSessions   LiveSession[]
  registrationFields RegistrationField[]
  certificateTemplate CertificateTemplate?
  districts      District[]
  branches       Branch[]
  departments    Department[]
}


// Content Structure
model Product {
  id                 String   @id @default(cuid())
  name               String
  description        String
  imageUrl           String
  imageHint          String?
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  courses     Course[]
}

model Course {
  id                 String   @id @default(cuid())
  title              String
  description        String
  imageUrl           String?
  imageHint          String?
  imageDescription   String?
  status             CourseStatus @default(PENDING)
  rejectionReason    String?
  isPublic           Boolean @default(true)

  productId          String?
  product            Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  modules     Module[]
  quiz        Quiz?
  isPaid      Boolean  @default(false)
  price       Float?
  currency    Currency?

  hasCertificate     Boolean @default(false)
  completedBy        UserCompletedCourse[]
  learningPathCourses LearningPathCourse[]
  resetRequests      ResetRequest[]
}

model LearningPath {
    id                 String   @id @default(cuid())
    title              String
    description        String
    hasCertificate     Boolean @default(false)
    trainingProviderId String
    trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

    courses            LearningPathCourse[]
}

model LearningPathCourse {
    learningPath    LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
    learningPathId  String
    course          Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    courseId        String
    order           Int

    @@id([learningPathId, courseId])
}


model Module {
  id        String   @id @default(cuid())
  title     String
  type      ModuleType
  duration  Int
  content   String
  description String
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completedBy UserCompletedModule[]
  createdAt DateTime @default(now())
}

// Assessments
model Quiz {
  id           String     @id @default(cuid())
  courseId     String     @unique
  course       Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions    Question[]
  passingScore Int
  timeLimit    Int
  quizType     QuizType
  maxAttempts  Int @default(0)
  requiresManualGrading Boolean @default(false)
  submissions  QuizSubmission[]
}

model Question {
  id              String   @id @default(cuid())
  text            String
  type            QuestionType
  quizId          String
  quiz            Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options         Option[]
  correctAnswerId String
  weight          Float @default(1)
  createdAt       DateTime @default(now())
  answers         Answer[]
}

model Option {
  id         String   @id @default(cuid())
  text       String
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  selectedInAnswers Answer[]
}

model QuizSubmission {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  quiz       Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId     String
  submittedAt DateTime @default(now())
  score       Int?
  status      SubmissionStatus @default(PENDING_REVIEW)
  gradedAt   DateTime?
  answers    Answer[]
}

model Answer {
  id               String  @id @default(cuid())
  submission       QuizSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  submissionId     String
  question         Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId       String
  selectedOption   Option?   @relation(fields: [selectedOptionId], references: [id], onDelete: NoAction)
  selectedOptionId String?
  answerText       String?
}

// User Progress
model UserCompletedCourse {
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId       String
  completionDate DateTime @default(now())
  score          Int

  @@id([userId, courseId])
}

model UserCompletedModule {
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId  String
  completedAt DateTime @default(now())

  @@id([userId, moduleId])
}

// Live Sessions
model LiveSession {
  id           String      @id @default(cuid())
  title        String
  description  String
  speaker      String
  keyTakeaways String
  dateTime     DateTime
  platform     LiveSessionPlatform
  joinUrl      String
  recordingUrl String?
  isRestricted Boolean     @default(false)
  status       LiveSessionStatus @default(UPCOMING)
  
  trainingProviderId String
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  allowedAttendees UserAttendedLiveSession[]
  attendedBy   UserAttendedLiveSession[]
}

model UserAttendedLiveSession {
  user      User     @relation(name: "attendedBy", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  session   LiveSession @relation(name: "attendedBy", fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String
  attendedAt DateTime @default(now())

  @@id([userId, sessionId])
}

model LiveSessionAllowedUser {
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId    String
    session   LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    sessionId String
    
    @@id([userId, sessionId])
}


// Badges
model Badge {
    id          String @id @default(cuid())
    title       String @unique
    description String
    icon        String
    users       UserBadge[]
}

model UserBadge {
    user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId  String
    badge   Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
    badgeId String
    earnedAt DateTime @default(now())

    @@id([userId, badgeId])
}


model Notification {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  title       String
  description String
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model LoginHistory {
    id        String   @id @default(cuid())
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId    String
    loginTime DateTime @default(now())
    ipAddress String?
    userAgent String?
}

model CertificateTemplate {
    id                String     @id @default(cuid())
    title             String
    organization      String
    body              String
    logoUrl           String?
    signatoryName     String
    signatoryTitle    String
    signatureUrl      String?
    stampUrl          String?
    primaryColor      String?
    borderStyle       String?
    templateStyle     String?
    trainingProvider  TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
    trainingProviderId String     @unique
}

model RegistrationField {
  id       String    @id @default(cuid())
  label    String
  type     FieldType
  enabled  Boolean
  required Boolean
  options  String[]
  isLoginIdentifier Boolean @default(false)
  trainingProviderId String?
  trainingProvider   TrainingProvider? @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model District {
  id       String    @id @default(cuid())
  name     String
  branches Branch[]
  users    User[]
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  trainingProviderId String
}

model Branch {
  id       String    @id @default(cuid())
  name     String
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  districtId String
  users      User[]
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  trainingProviderId String
}

model Department {
  id    String @id @default(cuid())
  name  String
  users User[]
  trainingProvider   TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  trainingProviderId String
}

model ResetRequest {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId  String
  status    RequestStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ModuleType {
  VIDEO
  PDF
  SLIDES
  AUDIO
}

enum QuestionType {
    MULTIPLE_CHOICE
    TRUE_FALSE
    FILL_IN_THE_BLANK
    SHORT_ANSWER
}

enum QuizType {
  OPEN_LOOP
  CLOSED_LOOP
}

enum LiveSessionPlatform {
  Zoom
  Google_Meet
}

enum LiveSessionStatus {
  UPCOMING
  LIVE
  ENDED
}

enum Currency {
  USD
  ETB
}

enum CourseStatus {
    PENDING
    PUBLISHED
    REJECTED
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubmissionStatus {
  PENDING_REVIEW
  COMPLETED
}
