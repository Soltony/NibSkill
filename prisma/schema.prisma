// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// ENUMS
enum ModuleType {
  VIDEO
  PDF
  SLIDES
  AUDIO
}

enum CourseStatus {
  PENDING
  PUBLISHED
  REJECTED
}

enum Currency {
  USD
  ETB
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_THE_BLANK
  SHORT_ANSWER
}

enum QuizType {
  OPEN_LOOP
  CLOSED_LOOP
}

enum LiveSessionPlatform {
  Zoom
  Google_Meet
}

enum LiveSessionStatus {
  UPCOMING
  LIVE
  ENDED
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubmissionStatus {
  PENDING_REVIEW
  COMPLETED
}


// MODELS
model TrainingProvider {
  id              String            @id @default(cuid())
  name            String            @unique
  address         String
  accountNumber   String            @unique
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  users           User[]
  products        Product[]
  courses         Course[]
  learningPaths   LearningPath[]
  liveSessions    LiveSession[]
  certificateTemplate CertificateTemplate?
  roles           Role[]
  districts       District[]
  departments     Department[]
  registrationFields RegistrationField[]
}


model User {
  id                      String                  @id @default(cuid())
  name                    String
  email                   String?                 @unique
  phoneNumber             String?                 @unique
  password                String?
  avatarUrl               String?
  departmentId            String?
  districtId              String?
  branchId                String?
  activeSessionId         String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt

  trainingProviderId      String?
  trainingProvider        TrainingProvider?       @relation(fields: [trainingProviderId], references: [id])
  
  department              Department?             @relation(fields: [departmentId], references: [id])
  district                District?               @relation(fields: [districtId], references: [id])
  branch                  Branch?                 @relation(fields: [branchId], references: [id])

  roles                   UserRole[]
  completedCourses        UserCompletedCourse[]
  completedModules        UserCompletedModule[]
  userBadges              UserBadge[]
  attendedLiveSessions    UserAttendedLiveSession[]
  allowedLiveSessions     LiveSessionAllowedUser[]
  loginHistory            LoginHistory[]
  notifications           Notification[]
  quizSubmissions         QuizSubmission[]
  resetRequests           ResetRequest[]
  purchasedCourses        UserPurchasedCourse[]
}

model Role {
  id                      String                  @id @default(cuid())
  name                    String
  permissions             Json
  trainingProviderId      String?
  trainingProvider        TrainingProvider?       @relation(fields: [trainingProviderId], references: [id])
  users                   UserRole[]

  @@unique([name, trainingProviderId])
}

model UserRole {
  id              String            @id @default(cuid())
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  role            Role              @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId          String
  
  @@unique([userId, roleId])
}

model LoginHistory {
  id                      String    @id @default(cuid())
  userId                  String
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  loginTime               DateTime  @default(now())
  ipAddress               String?
  userAgent               String?
  superAppToken           String?
}

model Product {
  id                      String    @id @default(cuid())
  name                    String
  description             String
  imageUrl                String
  imageHint               String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  courses                 Course[]
  
  trainingProviderId      String
  trainingProvider        TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model Course {
  id                      String    @id @default(cuid())
  title                   String
  description             String
  imageUrl                String?
  imageDescription        String?
  imageHint               String?
  isPaid                  Boolean   @default(false)
  price                   Float?
  currency                Currency?
  hasCertificate          Boolean   @default(false)
  isPublic                Boolean   @default(true)
  status                  CourseStatus @default(PENDING)
  rejectionReason         String?
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  productId               String?
  product                 Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)

  modules                 Module[]
  learningPathCourses     LearningPathCourse[]
  completedBy             UserCompletedCourse[]
  quiz                    Quiz?
  resetRequests           ResetRequest[]
  purchasedBy             UserPurchasedCourse[]

  trainingProviderId      String
  trainingProvider        TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model UserPurchasedCourse {
    userId              String
    courseId            String
    purchasedAt         DateTime @default(now())
    transactionId       String?  @unique
    amount              Float
    
    user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    course              Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

    @@id([userId, courseId])
}

model PendingTransaction {
    transactionId       String    @id
    userId              String
    courseId            String
    amount              Float
    createdAt           DateTime  @default(now())
}

model Module {
  id                      String    @id @default(cuid())
  title                   String
  description             String
  type                    ModuleType
  duration                Int
  content                 String
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  courseId                String
  course                  Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completedBy             UserCompletedModule[]
}

model UserCompletedModule {
  userId                  String
  moduleId                String
  completionDate          DateTime  @default(now())

  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  module                  Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  @@id([userId, moduleId])
}

model LearningPath {
  id                      String    @id @default(cuid())
  title                   String
  description             String?
  hasCertificate          Boolean   @default(false)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  courses                 LearningPathCourse[]
  
  trainingProviderId      String
  trainingProvider        TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
}

model LearningPathCourse {
  learningPathId          String
  learningPath            LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  courseId                String
  course                  Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  order                   Int

  @@id([learningPathId, courseId])
}

model UserCompletedCourse {
  userId                  String
  courseId                String
  completionDate          DateTime  @default(now())
  score                   Float

  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course                  Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@id([userId, courseId])
}

model Quiz {
  id                      String    @id @default(cuid())
  passingScore            Int
  timeLimit               Int?      // in minutes
  quizType                QuizType  @default(CLOSED_LOOP)
  requiresManualGrading   Boolean   @default(false)
  maxAttempts             Int       @default(0) // 0 for unlimited
  
  courseId                String    @unique
  course                  Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions               Question[]
  submissions             QuizSubmission[]
}

model Question {
  id                      String    @id @default(cuid())
  text                    String
  type                    QuestionType
  correctAnswerId         String
  weight                  Float     @default(1)
  createdAt               DateTime  @default(now())
  
  quizId                  String
  quiz                    Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options                 Option[]
  answers                 Answer[]
}

model Option {
  id                      String    @id @default(cuid())
  text                    String
  createdAt               DateTime  @default(now())
  
  questionId              String
  question                Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedInAnswers       Answer[]
}

model QuizSubmission {
  id                  String           @id @default(cuid())
  userId              String
  quizId              String
  submittedAt         DateTime         @default(now())
  score               Float?
  status              SubmissionStatus @default(PENDING_REVIEW)
  gradedAt            DateTime?

  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz                Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers             Answer[]
}

model Answer {
  id                  String        @id @default(cuid())
  submissionId        String
  questionId          String
  selectedOptionId    String?
  answerText          String?
  
  submission        QuizSubmission  @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question          Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption    Option?         @relation(fields: [selectedOptionId], references: [id], onDelete: SetNull)
}

model LiveSession {
  id                      String    @id @default(cuid())
  title                   String
  description             String
  speaker                 String
  keyTakeaways            String
  dateTime                DateTime
  platform                LiveSessionPlatform
  joinUrl                 String
  recordingUrl            String?
  status                  LiveSessionStatus @default(UPCOMING)
  isRestricted            Boolean   @default(false)
  
  trainingProviderId      String
  trainingProvider        TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)

  attendedBy              UserAttendedLiveSession[]
  allowedAttendees        LiveSessionAllowedUser[]
}

model UserAttendedLiveSession {
    userId              String
    sessionId           String
    attendedAt          DateTime  @default(now())

    user                User @relation(fields: [userId], references: [id], onDelete: Cascade)
    session             LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

    @@id([userId, sessionId])
}

model LiveSessionAllowedUser {
    userId              String
    sessionId           String

    user                User @relation(fields: [userId], references: [id], onDelete: Cascade)
    session             LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

    @@id([userId, sessionId])
}

model Badge {
    id              String    @id @default(cuid())
    title           String    @unique
    description     String
    icon            String
    users           UserBadge[]
}

model UserBadge {
    userId          String
    badgeId         String
    earnedAt        DateTime  @default(now())

    user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    badge           Badge     @relation(fields: [badgeId], references: [id], onDelete: Cascade)

    @@id([userId, badgeId])
}

model CertificateTemplate {
  id                      String    @id @default(cuid())
  trainingProviderId      String    @unique
  trainingProvider        TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
  title                   String
  organization            String
  body                    String
  logoUrl                 String?
  signatoryName           String
  signatoryTitle          String
  signatureUrl            String?
  stampUrl                String?
  primaryColor            String?
  borderStyle             String?
  templateStyle           String?
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

model District {
    id                      String    @id @default(cuid())
    name                    String
    trainingProviderId      String
    trainingProvider        TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
    branches                Branch[]
    users                   User[]
    
    @@unique([name, trainingProviderId])
}

model Branch {
    id                      String    @id @default(cuid())
    name                    String
    trainingProviderId      String
    trainingProvider        TrainingProvider?       @relation(fields: [trainingProviderId], references: [id])
    districtId              String
    district                District  @relation(fields: [districtId], references: [id], onDelete: Cascade)
    users                   User[]
    
    @@unique([name, districtId])
}

model Department {
    id                      String    @id @default(cuid())
    name                    String
    trainingProviderId      String
    trainingProvider        TrainingProvider @relation(fields: [trainingProviderId], references: [id], onDelete: Cascade)
    users                   User[]
    
    @@unique([name, trainingProviderId])
}

model RegistrationField {
    id                      String     @id @default(cuid())
    label                   String
    type                    FieldType
    enabled                 Boolean
    required                Boolean
    options                 String[]
    isLoginIdentifier       Boolean    @default(false)
    createdAt               DateTime   @default(now())
    trainingProviderId      String?
    trainingProvider        TrainingProvider? @relation(fields: [trainingProviderId], references: [id])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String
  createdAt   DateTime @default(now())
  isRead      Boolean  @default(false)
}

model ResetRequest {
  id          String        @id @default(cuid())
  userId      String
  courseId    String
  status      RequestStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
}
